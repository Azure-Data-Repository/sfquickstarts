{
    "Description": "\nThis template deploys a VPC, with a pair of public and private subnets spread  across two Availabilty Zones. It deploys an Internet Gateway, with a default  route on the public subnets. It deploys a pair of NAT Gateways (one in each AZ),  and default routes for them in the private subnets.\nhttps://github.com/aws-samples/ecs-refarch-cloudformation/blob/master/master.yaml\n",
    "Parameters" : {
         "SnowflakeAccount" : {
           "Description" : "Snowflake Account Name",
           "Type" : "String",
           "Default": ""
         },
         "SnowflakeUser" : {
           "Description" : "Username of the Snowflake account",
           "Type" : "String",
           "Default": "streaming_user"
         },
         "SnowflakePassword" : {
           "NoEcho" : "true",
           "Description" : "Password of your Snowflake account",
           "Type" : "String"
         },
         "Database" : {
           "Description" : "Snowflake Database",
           "Type" : "String",
           "Default": "msk_streaming_db"
         },
         "Schema" : {
           "Description" : "Snowflake schema",
           "Type" : "String",
           "Default": "msk_streaming_schema"
         },
         "Table" : {
           "Description" : "Snowflake table",
           "Type" : "String",
           "Default": "flights_vw"
         },
         "Role" : {
           "Description" : "Snowflake role",
           "Type" : "String",
           "Default": "msk_streaming_rl"
         },
         "Warehouse" : {
           "Description" : "Snowflake warehouse",
           "Type" : "String",
           "Default": "msk_streaming_wh"
         }
    },
    "Resources": {
        "VPC": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://jsnow-vhol-assets.s3.us-west-2.amazonaws.com/ecs/cfts/vpc.json",
                "Parameters": {
                    "EnvironmentName": {
                        "Ref": "AWS::StackName"
                    },
                    "VpcCIDR": "10.180.0.0/16",
                    "PublicSubnet1CIDR": "10.180.8.0/21",
                    "PublicSubnet2CIDR": "10.180.16.0/21",
                    "PrivateSubnet1CIDR": "10.180.24.0/21",
                    "PrivateSubnet2CIDR": "10.180.32.0/21"
                }
            }
        },
        "SecurityGroups": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://jsnow-vhol-assets.s3.us-west-2.amazonaws.com/ecs/cfts/security-groups.json",
                "Parameters": {
                    "EnvironmentName": {
                        "Ref": "AWS::StackName"
                    },
                    "VPC": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.VPC"
                        ]
                    }
                }
            }
        },
        "ALB": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://jsnow-vhol-assets.s3.us-west-2.amazonaws.com/ecs/cfts/load-balancers.json",
                "Parameters": {
                    "EnvironmentName": {
                        "Ref": "AWS::StackName"
                    },
                    "VPC": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.VPC"
                        ]
                    },
                    "Subnets": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.PublicSubnets"
                        ]
                    },
                    "SecurityGroup": {
                        "Fn::GetAtt": [
                            "SecurityGroups",
                            "Outputs.LoadBalancerSecurityGroup"
                        ]
                    }
                }
            }
        },
        "ECS": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://jsnow-vhol-assets.s3.us-west-2.amazonaws.com/ecs/cfts/ecs-cluster.json",
                "Parameters": {
                    "EnvironmentName": {
                        "Ref": "AWS::StackName"
                    },
                    "VPC": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.VPC"
                        ]
                    },
                    "SecurityGroup": {
                        "Fn::GetAtt": [
                            "SecurityGroups",
                            "Outputs.LoadBalancerSecurityGroup"
                        ]
                    },
                    "Subnets": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.PrivateSubnets"
                        ]
                    }
                }
            }
        },
        "WebsiteService": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://jsnow-vhol-assets.s3.us-west-2.amazonaws.com/ecs/cfts/web-service.json",
                "Parameters": {
                    "VPC": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.VPC"
                        ]
                    },
                    "Cluster": {
                        "Fn::GetAtt": [
                            "ECS",
                            "Outputs.Cluster"
                        ]
                    },
                    "DesiredCount": 2,
                    "Path": "/",
                    "LoadBalancer": {
                        "Fn::GetAtt": [
                            "ALB",
                            "Outputs.LoadBalancer"
                        ]
                    },
                    "Subnets": {
                        "Fn::GetAtt": [
                            "VPC",
                            "Outputs.PrivateSubnets"
                        ]
                    },
                    "SecurityGroup": {
                        "Fn::GetAtt": [
                            "SecurityGroups",
                            "Outputs.LoadBalancerSecurityGroup"
                        ]
                    },
                    "SnowflakeAccount": {"Ref": "SnowflakeAccount"},
                    "SnowflakeUser": {"Ref": "SnowflakeUser"},
                    "SnowflakePassword": {"Ref": "SnowflakePassword"},
                    "Database": {"Ref": "Database"},
                    "Schema": {"Ref": "Schema"},
                    "Table": {"Ref": "Table"},
                    "Role": {"Ref": "Role"},
                    "Warehouse": {"Ref": "Warehouse"}
                }
            }
        }
    },
    "Outputs": {
        "WebsiteServiceUrl": {
            "Description": "The URL endpoint for the website service",
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        {
                            "Fn::GetAtt": [
                                "ALB",
                                "Outputs.LoadBalancerUrl"
                            ]
                        },
                        "/"
                    ]
                ]
            }
        }
    }
}
