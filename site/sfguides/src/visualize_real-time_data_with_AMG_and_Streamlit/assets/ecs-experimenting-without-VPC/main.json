{
    "Description": "\nThis template deploys a VPC, with a pair of public and private subnets spread  across two Availabilty Zones. It deploys an Internet Gateway, with a default  route on the public subnets. It deploys a pair of NAT Gateways (one in each AZ),  and default routes for them in the private subnets.\nIt then deploys a highly available ECS cluster using an AutoScaling Group, with  ECS hosts distributed across multiple Availability Zones. \nFinally, it deploys a pair of example ECS services from containers published in  Amazon EC2 Container Registry (Amazon ECR).\nLast Modified: 22nd September 2016 Author: Paul Maddox <pmaddox@amazon.com>\nhttps://github.com/aws-samples/ecs-refarch-cloudformation/blob/master/master.yaml\n",
     "Parameters": {
        "VPC": {
            "Description": "The VPC that the ECS cluster is deployed to",
            "Type": "AWS::EC2::VPC::Id"
        },
        "Cluster": {
            "Description": "Please provide the ECS Cluster ID that this service should run on",
            "Type": "String",
            "Default": "jsnow-ecs-streamlit"
        },
        "DesiredCount": {
            "Description": "How many instances of this task should we run across our cluster?",
            "Type": "Number",
            "Default": 2
        },
        "MaxCount": {
            "Description": "Maximum number of instances of this task we can run across our cluster",
            "Type": "Number",
            "Default": 3
        },
        "Path": {
            "Description": "The path to register with the Application Load Balancer",
            "Type": "String",
            "Default": "/"
        },
        "Subnets": {
            "Description": "Choose which subnets this ECS cluster should be deployed to",
            "Type": "List<AWS::EC2::Subnet::Id>"
        },
        "SecurityGroup": {
            "Description": "Select the Security Group to use for the ECS cluster hosts",
            "Type": "AWS::EC2::SecurityGroup::Id"
        }
    },
    "Resources": {
        "ALB": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://jsnow-vhol-assets.s3.us-west-2.amazonaws.com/ecs/cfts/load-balancers.json",
                "Parameters": {
                    "EnvironmentName": {
                        "Ref": "AWS::StackName"
                    },
                    "VPC": { 
                       "Ref": "VPC" 
                    },
                    "Subnets": {
                       "Fn::Join": [",", {"Ref": "Subnets"}]
                    },
                    "SecurityGroup": {
                       "Ref": "SecurityGroup"
                    }
                }
            }
        },
        "ECS": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://jsnow-vhol-assets.s3.us-west-2.amazonaws.com/ecs/cfts/ecs-cluster.json",
                "Parameters": {
                    "EnvironmentName": {
                        "Ref": "AWS::StackName"
                    },
                    "InstanceType": "t2.large",
                    "ClusterSize": 4,
                    "VPC": {
                        "Ref": "VPC"
                    },
                    "SecurityGroup": {
                        "Ref": "SecurityGroup" 
                    },
                    "Subnets": {
                       "Fn::Join": [",", {"Ref": "Subnets"}]
                    }
                }
            }
        },
        "WebsiteService": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": "https://jsnow-vhol-assets.s3.us-west-2.amazonaws.com/ecs/cfts/web-service.json",
                "Parameters": {
                    "VPC": {
                       "Ref": "VPC"
                    },
                    "Cluster": {
                       "Ref": "Cluster"
                    },
                    "DesiredCount": 2,
                    "Path": "/",
                    "ECSServiceAutoScalingRoleARN": {
                        "Fn::GetAtt": [
                            "ECS",
                            "Outputs.ECSServiceAutoScalingRole"
                        ]
                    },
                    "LoadBalancer": {
                        "Fn::GetAtt": [
                            "ALB",
                            "Outputs.LoadBalancer"
                        ]
                    },
                    "Subnets": {
                       "Fn::Join": [",", {"Ref": "Subnets"}]
                    },
                    "SecurityGroup": {
                       "Ref": "SecurityGroup"
                    }
                }
            }
        }
    },
    "Outputs": {
        "WebsiteServiceUrl": {
            "Description": "The URL endpoint for the website service",
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        {
                            "Fn::GetAtt": [
                                "ALB",
                                "Outputs.LoadBalancerUrl"
                            ]
                        },
                        "/"
                    ]
                ]
            }
        }
    }
}
